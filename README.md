# Courses

## Описание

Этот проект представляет собой Django API, предназначенный для управления онлайн-курсами, уроками и платежами пользователей. Он предоставляет структурированный способ создания образовательного контента и управления им, а также отслеживания платежей пользователей. Проект включает команды управления для настройки исходных данных, создания тестовых пользователей и генерации платежей для этих пользователей.


# Инструкции по развертыванию на сервере

## Подготовьте удаленный сервер

1. **Создайте удаленный сервер **: Вы можете использовать любого облачного провайдера (например, AWS, DigitalOcean и т.д.) для создания удаленного сервера.
2. **Заполните информацию**:
 - Создайте файл .env в каталоге проекта и заполните его в соответствии с .env.sample
 - Добавьте необходимые секреты и переменные в разделе "Секреты" на GitHub.

### Oбзор необходимых секретов GitHub Secrets:

- 'DJANGO_SECRET_KEY' - Django secret key for the project.
- 'DOCKER_USERNAME' - Docker Hub username.
- 'DOCKER_PASSWORD' - Docker Hub password.
- 'SERVER_IP' - IP address of the remote server.
- 'SSH_KEY' - SSH key for accessing the remote server.
- 'SSH_USER' - SSH user for accessing the remote server.
- 'POSTGRES_USER' - PostgreSQL username.
- 'POSTGRES_PASSWORD' - PostgreSQL password.

### Обзор необходимых переменных на GitHub:

- 'CELERY_BROKER_URL' - URL for the Celery broker (Redis). **Default example: redis://redis:6379/1**
- 'CELERY_RESULT_BACKEND' - URL for the Celery result backend (Redis). **Default example: redis://redis:6379/1**
- 'REDIS_HOST' - Redis host. **Default example: redis://redis:6379//**
- 'DEBUG' - Debug mode for Django. **Default example: True**
- 'POSTGRES_DB' - PostgreSQL database name. **First create database locally on your machine**
- 'POSTGRES_HOST' - PostgreSQL host. **Default example: db - as specified inside docker-compose.yml (service: db)**
- 'POSTGRES_PORT' - PostgreSQL port. **Default example: 5432**

## После того как вы настроили удаленный сервер и ввели необходимые секретные данные и переменные, вы можете приступить к развертыванию.

Вам просто нужно выполнить push- или pull-запрос, и если все настроено правильно, развертывание будет выполнено автоматически.

Если вы хотите создать нового пользователя с правами администратора, вы можете сделать это, выполнив следующую команду на удаленном сервере:
#### Примечание: Сначала перейдите к каталогу проекта.
#### Примечание: Если у вас возникли проблемы с правами доступа, вы можете использовать команду sudo.

```sh
docker exec backend python3 manage.py createadmin
```

Теперь вы можете получить доступ к своему удаленному серверу, используя IP-адрес. Для получения более подробной информации о структуре проекта, пожалуйста, продолжайте следовать руководству

# Инструкции по локальной настройке проекта


Прежде всего, убедитесь, что на вашем компьютере установлены Docker и Docker Compose.


## Запуск проекта с помощью Docker Compose

Выполните следующие действия, чтобы запустить проект с помощью "docker-compose`:

1. **Клонирование репозитория**:
    ```sh
    git clone <repository_url>
    cd <repository_directory>
    ```

2. **Создание и конфигурация файла `.env`**:
    ```sh
    cp .env.example .env
    # Edit the .env file to set your environment variables
    ```

3. **Создание и запуск Docker контейнера**:
    ```sh
    docker-compose up --build
    ```

## Запуск проекта

Чтобы запустить проект в фоновом режиме с нуля, используйте следующую команду:
```sh
docker-compose up -d --build
```

Эта команда создаст и запустит все службы, определенные в файле `docker-compose.yml`.

## 
Проверка функциональности сервиса

После запуска проекта вы можете убедиться, что все службы работают корректно. Следующие команды помогут вам настроить исходные данные и протестировать пользователей:

- Создайте суперпользователя для Django:
    ```sh
    docker-compose exec backend python manage.py createadmin
    ```
  login: admin@test.com
  password: adminpass

- Создайте тестовых пользователей:
    ```sh
    docker-compose exec backend python manage.py create_test_users
    ```

- Создайте курсы и уроки:
    ```sh
    docker-compose exec backend python manage.py create_courses_and_lessons
    ```

#### Для работы с API удобно использовать Postman.

Все URL-адреса вы можете найти в файле `urls.py` или перейдя на страницу документации по адресу `http://localhost:8000/redoc/` или `http://localhost:8000/swagger/`.

- создайте пользователя с рабочим адресом электронной почты
- создайте подписку для пользователя с рабочим адресом электронной почты


Чтобы убедиться, что каждая служба работает правильно, выполните следующие действия:

1. ** Серверная служба**:
 - Получите доступ к серверной службе, перейдя по ссылке "http://localhost:8000` в вашем веб-браузере.
 - Убедитесь, что приложение Django запущено.

2. **Служба базы данных**:
 - Убедитесь, что база данных PostgreSQL запущена, проверив логи:
 ```sh
docker-создание базы данных журналов
 ```
 - Вы должны увидеть логи, указывающие на то, что база данных готова к приему подключений.


3. **Служба Redis**:
 - Убедитесь, что служба Redis запущена, проверив логи:
 ```sh
 docker-compose logs redis
 ```
 - Вы должны увидеть логи, указывающие на то, что Redis готов принимать подключения.

4. **Celery Worker**:
 - Убедитесь, что Celery worker запущен, проверив логи:
 ```sh
docker-создание журналов celery
 ```
 - Отправить запрос на обновление курса, на который подписан активный пользователь
 - Такой пользователь должен получить электронное письмо с уведомлением
 - Вы должны увидеть логи, указывающие на то, что Celery обрабатывает задачи.


5. ** Ритм сельдерея**:
 - Проверьте, запущен ли планировщик ритма сельдерея, проверив логи:
        ```sh
        docker-compose logs celery-beat
        ```
- Перейдите на страницу администратора и войдите в систему как суперпользователь
 - выберите любого активного пользователя и измените поле "последний вход" на дату, которая не менее 30 дней назад отличалась от текущей даты
 - Задача Celery beat переведет такого пользователя в неактивное состояние (период выполнения задачи по умолчанию равен 1 дню).
 - Вы должны увидеть логи, указывающие на то, что Celery beat scheduler запущен.

Выполнив эти действия, вы сможете убедиться в том, что каждая служба работает правильно.

## Возможности

- **Course Management**: Создание курсов и управление ими.
- **Lesson Management**: Создание уроков, связанных с курсами, и управление ими.
- **User Management**: Создание тестовых пользователей для целей тестирования.
- **Payment Management**: Создание платежей для пользователей и управление ими.

## Настройка

Чтобы настроить проект, выполните следующие действия:

1. **Create Courses and Lessons**: Эта команда создает или извлекает курсы и уроки.

    ```bash
    python manage.py create_courses_and_lessons
    ```

2. **Create Test Users**: Эта команда создает тестовых пользователей с адресами электронной почты, начинающимися с "user_".

    ```bash
    python manage.py create_test_users
    ```

3. **Create Payments**: Эта команда создает платежи для тестируемых пользователей, связывая их с созданными курсами и уроками.

    ```bash
    python manage.py create_payments
    ```

## Использовние

1. Используйте команду `create_courses_and_lessons` чтобы настроить начальные курсы и уроки.
2. Используйте команду `create_test_users`, чтобы создать тестовых пользователей.
3. Используйте команду `create_payments` чтобы сгенерировать платежи для тестовых пользователей.

Выполнив эти действия, вы получите полностью настроенную среду с курсами, уроками, тестовыми пользователями и соответствующими платежами.